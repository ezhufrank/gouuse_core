#!/usr/bin/env php
<?php

main($argc, $argv);

function main($argc, $argv)
{
	 if ($argc <= 1) {
            echo '请输入code目标文件名' . PHP_EOL;
            echo  PHP_EOL;
    } else {

        $root = __DIR__.'/../../../../../';
        
        $app = require $root. '/bootstrap/app.php';
    
		$codelib = $root . 'app/Libraries/CodeLib.php';
		if (!is_writable($root . 'resources/options/zh_cn/')) {
		    echo '请将'.$root . 'resources/options/zh_cn/目录设为可写权限';
		    echo  PHP_EOL;
		    echo  PHP_EOL;
		    return;
		}
		if (!is_file($codelib)) {
		    echo '请确保app/Libraries/CodeLib.php是否在项目目录下';
		    echo  PHP_EOL;
		} else {
		    $handle = fopen($codelib, 'r');
		    $respon_file = $root . 'resources/options/zh_cn/'.$argv[1];
		    $str = "<?php\n".'$config = ['."\n";
		    file_put_contents($respon_file, $str);
		    $json = [];
		    $common_code = [
		    	404 => '访问地址不存在',
		    	500 => '服务器内部错误'
		    ];
		    while(!feof($handle)){
		        $line = fgets($handle);
		        if ($index = strpos($line, 'const')) {
		            $line = substr($line, $index+5);
		            $index_equal = strpos($line, '=') + 1;
		            $index_comm = strpos($line, '//')+2;
		           
		            $key = substr($line, $index_equal, stripos($line, ';') - $index_equal);
		            
		            $commds = str_replace("\n", '', substr($line,$index_comm));
		           
		            $str = "    ". trim($key) . " => '" . addslashes($commds)."',\n";
		            file_put_contents($respon_file, $str, FILE_APPEND);
		            $json[trim($key)] = addslashes($commds);
		        }
		    }
		    foreach (common_code as $key => $info) {
		    	 $str = "    ". trim($key) . " => '" . addslashes($info)."',\n";
		    	  file_put_contents($respon_file, $str, FILE_APPEND);
		    }
		    $str = '];'."\n";
		    file_put_contents($respon_file, $str, FILE_APPEND);
		    $json = json_encode($json, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT);
		    file_put_contents($root."public/swagger-docs/code.json", $json);
		}
        
    }
}

